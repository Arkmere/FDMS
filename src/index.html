<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vectair FDMS Lite</title>
    <link rel="stylesheet" href="./css/vectair.css" />
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <header class="header">
        <div class="header-left">
          <div class="va-logo-box">VA</div>
          <div>
            <div class="va-title-main">Vectair FDMS Lite</div>
            <div class="va-title-sub">EGOW / RAF Woodvale</div>
          </div>
        </div>
        <div class="header-right">
          <div id="clockDisplay" class="clock-display">
            <div class="clock-line"><strong>UTC</strong> <span id="utcTime">--:--:--</span></div>
            <div class="clock-line" id="localTimeLine" style="display: none;"><strong>Loc</strong> <span id="localTime">--:--:--</span></div>
            <div class="clock-line"><strong>Date</strong> <span id="dateDisplay">--/--/--</span></div>
          </div>
        </div>
      </header>

      <nav class="nav-bar">
        <div class="nav-tabs" role="tablist">
          <button class="nav-tab active" data-tab="tab-live">Live Board</button>
          <button class="nav-tab" data-tab="tab-calendar">Calendar</button>
          <button class="nav-tab" data-tab="tab-booking">Booking</button>
          <button class="nav-tab" data-tab="tab-history">History</button>
          <button class="nav-tab" data-tab="tab-reports">Reports</button>
          <button class="nav-tab" data-tab="tab-vkb">VKB Lookup</button>
          <button class="nav-tab" data-tab="tab-admin">Admin</button>
        </div>
      </nav>

      <main class="page-body">
        <!-- LIVE -->
        <section id="tab-live" class="tab-panel">
          <div class="liveboard-header">
            <div class="liveboard-title-row">
              <div>
                <div class="page-title">Live Board</div>
                <div class="page-subtitle">Administrative strip-style movement list (not a controlling system).</div>
              </div>
              <div class="liveboard-stats-bar">
                <!-- Daily Movement Counters -->
                <div class="daily-stats-section" title="Today's movement statistics">
                  <div class="stats-row">
                    <div class="stat-item" title="Booked Movements (Planned for today)">
                      <span class="stat-label">BM</span>
                      <span class="stat-value" id="statBookedMvmts">0</span>
                    </div>
                    <div class="stat-item" title="Booked Completed (Completed today)">
                      <span class="stat-label">BC</span>
                      <span class="stat-value" id="statBookedComp">0</span>
                    </div>
                    <div class="stat-item" title="VFR Movements (Active today)">
                      <span class="stat-label">VM</span>
                      <span class="stat-value" id="statVfrMvmts">0</span>
                    </div>
                    <div class="stat-item" title="VFR Completed (VFR completed today)">
                      <span class="stat-label">VC</span>
                      <span class="stat-value" id="statVfrComp">0</span>
                    </div>
                    <div class="stat-item stat-total" title="Total movements today">
                      <span class="stat-label">Total</span>
                      <span class="stat-value" id="statTotalToday">0</span>
                    </div>
                  </div>
                </div>
                <div class="stats-divider"></div>
                <!-- FIS Counter Section -->
                <div class="fis-stats-section" title="FIS (Flight Information Service) statistics">
                  <div class="stats-row">
                    <div class="stat-item" title="Manual FIS (non-strip counted)">
                      <span class="stat-label">Manual FIS</span>
                      <div class="stat-counter">
                        <button class="counter-btn-sm" id="btnDecGenericOvr" type="button" aria-label="Decrease generic FIS">−</button>
                        <span class="stat-value" id="genericOvrCount">0</span>
                        <button class="counter-btn-sm" id="btnIncGenericOvr" type="button" aria-label="Increase generic FIS">+</button>
                      </div>
                    </div>
                    <div class="stat-item" title="Strip FIS count">
                      <span class="stat-label">Strip FIS</span>
                      <span class="stat-value" id="stripFisCount">0</span>
                    </div>
                    <div class="stat-item stat-fis-total" title="Total FIS count">
                      <span class="stat-label">TOTAL FIS</span>
                      <span class="stat-value fis-total" id="totalFisCount">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="toolbar">
              <div class="toolbar-left">
                <select class="field field-select" id="statusFilter" aria-label="Filter by status">
                  <option value="planned_active" selected>Planned & Active</option>
                  <option value="active">Active only</option>
                  <option value="all">All</option>
                </select>

                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                  <span style="white-space: nowrap;">Planned window:</span>
                  <select class="field field-select" id="plannedWindowHours" style="width: auto;" aria-label="Filter by planned time window">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="4">4 hours</option>
                    <option value="8">8 hours</option>
                    <option value="12">12 hours</option>
                    <option value="24" selected>24 hours</option>
                    <option value="48">48 hours</option>
                    <option value="168">7 days</option>
                    <option value="999999">All future</option>
                  </select>
                </label>
              </div>

              <div class="toolbar-right">
                <button class="btn btn-ft btn-ft-loc" id="btnNewLoc" type="button" aria-label="Create new local flight">New LOC</button>
                <button class="btn btn-ft btn-ft-dep" id="btnNewDep" type="button" aria-label="Create new departure">New DEP</button>
                <button class="btn btn-ft btn-ft-arr" id="btnNewArr" type="button" aria-label="Create new arrival">New ARR</button>
                <button class="btn btn-ft btn-ft-ovr" id="btnNewOvr" type="button" aria-label="Create new planned overflight">New OVR</button>
              </div>
            </div>

            <!-- Timeline View -->
            <div class="timeline-container" id="timelineContainer">
              <div class="timeline-header">
                <span class="timeline-title">Day Timeline (UTC)</span>
                <span class="timeline-current-time" id="timelineCurrentTime">--:--</span>
              </div>
              <div class="timeline-scale" id="timelineScale">
                <!-- Hour markers inserted by JS -->
              </div>
              <div class="timeline-tracks" id="timelineTracks">
                <!-- Movement bars inserted by JS -->
              </div>
              <div class="timeline-now-line" id="timelineNowLine" style="display: none;">
                <span class="timeline-now-label">NOW</span>
              </div>
            </div>

            <div class="table-container">
              <table aria-label="Live Board movements">
                <thead>
                  <tr>
                    <th scope="col" style="width: 14px"></th>
                    <th scope="col">Callsign</th>
                    <th scope="col" style="width: 36px; text-align: center" title="Flight Priority"></th>
                    <th scope="col">Reg / Type / WTC</th>
                    <th scope="col">Route</th>
                    <th scope="col" style="width: 50px; text-align: center">Rules</th>
                    <th scope="col">Times</th>
                    <th scope="col" style="width: 80px; text-align: center">T&amp;G</th>
                    <th scope="col" style="width: 80px; text-align: center">O/S</th>
                    <th scope="col" style="width: 80px; text-align: center">FIS</th>
                    <th scope="col">Remarks</th>
                    <th scope="col" style="width: 250px; text-align: right">Actions</th>
                  </tr>
                </thead>
                <tbody id="liveBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- CALENDAR -->
        <section id="tab-calendar" class="tab-panel hidden">
          <div class="page-title">Calendar</div>
          <div class="page-subtitle">View bookings and daily operations. Click a booking to see full details.</div>

          <div class="calendar-toolbar">
            <div class="calendar-nav">
              <button type="button" class="btn btn-secondary" id="btnCalendarPrev" title="Previous month">&lt;</button>
              <span class="calendar-month-label" id="calendarMonthLabel">January 2026</span>
              <button type="button" class="btn btn-secondary" id="btnCalendarNext" title="Next month">&gt;</button>
              <button type="button" class="btn btn-secondary" id="btnCalendarToday">Today</button>
            </div>
            <div class="calendar-actions">
              <button type="button" class="btn btn-primary" id="btnAddCalendarEvent">+ Add Event</button>
            </div>
          </div>

          <div class="panel calendar-panel">
            <div class="calendar-grid" id="calendarGrid">
              <!-- Calendar will be rendered here -->
            </div>
          </div>

          <!-- Booking Details Drawer -->
          <div class="booking-details-drawer" id="bookingDetailsDrawer" style="display: none;">
            <div class="drawer-header">
              <h3 class="drawer-title">Booking Details</h3>
              <button type="button" class="btn btn-ghost" id="btnCloseDrawer">Close</button>
            </div>
            <div class="drawer-content" id="drawerContent">
              <!-- Booking details will be rendered here -->
            </div>
          </div>
        </section>

        <!-- BOOKING -->
        <section id="tab-booking" class="tab-panel hidden">
          <div class="page-title">Booking</div>
          <div class="page-subtitle">Collect visitor details, auto-calculate charges, then create a planned strip on the Live Board.</div>

          <div class="booking-layout">
            <!-- Left: Booking Form -->
            <div class="booking-form-panel panel">
              <h3 class="panel-header">Booking details</h3>

              <!-- Aircraft Section (moved to top) -->
              <div class="booking-section">
                <div class="booking-section-title">Aircraft</div>
                <div class="booking-form-grid">
                  <div class="modal-field">
                    <label class="modal-label">Aircraft registration <span class="required-mark">*</span></label>
                    <div class="autocomplete-container">
                      <input type="text" id="bookingRegistration" class="modal-input" placeholder="G-ABCD" required style="text-transform: uppercase;">
                      <span id="profileLoadedIndicator" class="profile-indicator" style="display: none;"></span>
                    </div>
                    <div class="registry-buttons">
                      <button type="button" class="btn btn-registry btn-small" id="btnCaaGinfo" title="Open CAA G-INFO register (copies registration without G-)">CAA G-INFO</button>
                      <button type="button" class="btn btn-registry btn-small" id="btnFaaRegistry" title="Open FAA N-Number Registry">FAA Registry</button>
                    </div>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Callsign (if different)</label>
                    <input type="text" id="bookingCallsign" class="modal-input" placeholder="Optional" style="text-transform: uppercase;">
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Aircraft type <span class="required-mark">*</span></label>
                    <input type="text" id="bookingAircraftType" class="modal-input" placeholder="PA28" required style="text-transform: uppercase;">
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">MTOW <span class="required-mark">*</span></label>
                    <div style="display: flex; gap: 6px; align-items: center;">
                      <input type="number" id="bookingMtow" class="modal-input" min="0" step="1" placeholder="1000" required style="flex: 1;">
                      <select id="bookingMtowUnit" class="modal-select" style="width: auto;">
                        <option value="kg" selected>kg</option>
                        <option value="t">tonnes</option>
                      </select>
                    </div>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Persons on Board <span class="required-mark">*</span></label>
                    <input type="number" id="bookingPob" class="modal-input" min="1" step="1" placeholder="2" required>
                  </div>
                  <div class="modal-field">
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingTrainingRate">
                      <span>Training rate applies (25% of landing fees).</span>
                    </label>
                  </div>
                  <div class="modal-field">
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingHasCuiw">
                      <span>Has Civil User Indemnity Waiver (CUIW)</span>
                    </label>
                    <div class="help-text">If unchecked, a £25 waiver fee will be added to charges.</div>
                  </div>
                </div>
              </div>

              <!-- Contact Section -->
              <div class="booking-section">
                <div class="booking-section-title">Contact / Pilot</div>
                <div class="booking-form-grid">
                  <div class="modal-field">
                    <label class="modal-label">Name <span class="required-mark">*</span></label>
                    <input type="text" id="bookingContactName" class="modal-input" placeholder="Jane Smith" required>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Contact number <span class="required-mark">*</span></label>
                    <input type="tel" id="bookingContactPhone" class="modal-input" placeholder="+44 7123 456789" required>
                  </div>
                </div>
                <div class="help-text" style="margin-top: 6px; font-size: 11px;">
                  Pilot details are auto-saved with registration for future bookings.
                </div>
              </div>

              <!-- Schedule Section -->
              <div class="booking-section">
                <div class="booking-section-title">Schedule</div>
                <div class="booking-form-grid">
                  <div class="modal-field">
                    <label class="modal-label">Date of flight <span class="required-mark">*</span></label>
                    <input type="date" id="bookingDof" class="modal-input" required>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Time of arrival (LT) <span class="required-mark">*</span></label>
                    <input type="time" id="bookingArrivalTime" class="modal-input" required>
                  </div>
                  <div class="modal-field span-2">
                    <label class="modal-label">Length of stay (hours) <span class="required-mark">*</span></label>
                    <input type="number" id="bookingStayHours" class="modal-input" min="0" step="0.5" placeholder="3" required>
                    <div class="help-text">Used for parking calculation (first 2 hours free).</div>
                  </div>
                </div>
              </div>

              <!-- Operational Section -->
              <div class="booking-section">
                <div class="booking-section-title">Operational</div>
                <div class="booking-form-grid">
                  <div class="modal-field">
                    <label class="modal-label">Departure aerodrome <span class="required-mark">*</span></label>
                    <input type="text" id="bookingDepartureAd" class="modal-input" placeholder="EGNM" required style="text-transform: uppercase;">
                    <div class="help-text">Use ZZZZ for unlisted locations</div>
                  </div>
                  <div class="modal-field" id="bookingDepNameField" style="display: none;">
                    <label class="modal-label">Location name (for ZZZZ) <span class="required-mark">*</span></label>
                    <input type="text" id="bookingDepartureName" class="modal-input" placeholder="Main Hall Farm, Cambridge">
                    <div class="help-text">Plain English name - will appear in remarks</div>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Number of landings (T&amp;G + full stops) <span class="required-mark">*</span></label>
                    <input type="number" id="bookingLandingsCount" class="modal-input" min="1" step="1" placeholder="4" required>
                  </div>
                  <div class="modal-field">
                    <label class="modal-label">Arrival type</label>
                    <select id="bookingArrivalType" class="modal-select">
                      <option value="ARR" selected>ARR (visiting arrival)</option>
                      <option value="LOC">LOC (local training)</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Other Requirements Section -->
              <div class="booking-section">
                <div class="booking-section-title">Other requirements</div>
                <div class="booking-form-grid">
                  <div class="modal-field span-2">
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingParkingRequired" checked>
                      <span>Parking</span>
                    </label>
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingFuelRequired">
                      <span>Fuel required</span>
                    </label>
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingVisitingCars">
                      <span>Visiting cars</span>
                    </label>
                  </div>
                  <div class="modal-field span-2">
                    <label class="modal-label">Notes / special requirements</label>
                    <textarea id="bookingNotes" class="modal-textarea" rows="3" placeholder="Ramp parking. Pickup by hire car."></textarea>
                  </div>
                  <!-- System Notes Block (read-only, auto-populated from VKB/profile) -->
                  <div class="modal-field span-2" id="bookingSystemNotesContainer" style="display: none;">
                    <label class="modal-label">System notes</label>
                    <div id="bookingSystemNotes" class="system-notes-block"></div>
                  </div>
                </div>
              </div>

              <!-- Profile Management Section -->
              <div class="booking-section">
                <div class="booking-section-title">Profile</div>
                <div class="booking-form-grid">
                  <div class="modal-field span-2">
                    <label class="booking-checkbox-label">
                      <input type="checkbox" id="bookingSaveProfile">
                      <span>Save booking profile for this registration</span>
                    </label>
                    <div class="help-text">Saves aircraft details, contact info, and notes for future autofill.</div>
                  </div>
                  <div class="modal-field span-2">
                    <div class="profile-actions">
                      <button type="button" class="btn btn-secondary btn-small" id="btnExportProfiles" title="Export all booking profiles to JSON">Export Profiles</button>
                      <button type="button" class="btn btn-secondary btn-small" id="btnImportProfiles" title="Import booking profiles from JSON">Import Profiles</button>
                    </div>
                    <div class="help-text" style="margin-top: 6px;">Manage saved booking profiles for repeat visitors.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right: Charges & Strip Preview -->
            <div class="booking-right-panel">
              <!-- Charges Panel -->
              <div class="booking-charges-panel panel">
                <h3 class="panel-header">Charges &amp; strip preview</h3>

                <div class="charges-breakdown">
                  <div class="charge-line">
                    <span class="charge-label">Landing fees <span class="charge-note">(ex VAT)</span></span>
                    <span class="charge-value" id="chargeLandingNet">£0.00</span>
                  </div>
                  <div class="charge-line">
                    <span class="charge-label">Parking <span class="charge-note">(incl VAT)</span></span>
                    <span class="charge-value" id="chargeParkingGross">£0.00</span>
                  </div>
                  <div class="charge-line charge-vat">
                    <span class="charge-label">VAT <span class="charge-note">(parking only, 20%)</span></span>
                    <span class="charge-value" id="chargeParkingVat">£0.00</span>
                  </div>
                  <div class="charge-line" id="chargeCuiwLine" style="display: none;">
                    <span class="charge-label">CUIW fee <span class="charge-note">(no waiver)</span></span>
                    <span class="charge-value" id="chargeCuiw">£0.00</span>
                  </div>
                  <div class="charge-line charge-total">
                    <span class="charge-label">Total <span class="charge-note">(mixed VAT)</span></span>
                    <span class="charge-value" id="chargeTotalGross">£0.00</span>
                  </div>
                </div>

                <div class="charges-notes">
                  <div class="charge-note-item"><span class="bullet bullet-landing"></span> Landing fee: <span id="chargeNoteLandingRate">£0.00</span> per landing</div>
                  <div class="charge-note-item"><span class="bullet bullet-parking"></span> Parking: <span id="chargeNoteParkingPeriods">0</span> x 24h period(s)</div>
                  <div class="charge-note-item charge-note-fuel" id="chargeNoteFuel" style="display: none;"><span class="bullet bullet-fuel"></span> Fuel: Quote required</div>
                </div>

                <!-- Strip Preview -->
                <div class="strip-preview-section">
                  <h4 class="strip-preview-title">Planned strip <span class="strip-preview-note">(preview)</span></h4>
                  <div class="strip-preview-card">
                    <div class="strip-preview-header">
                      <div class="strip-preview-reg" id="stripPreviewReg">G-ABCD</div>
                      <div class="strip-preview-time" id="stripPreviewTime">14:30 / 27/05/24</div>
                    </div>
                    <div class="strip-preview-type" id="stripPreviewType">PA28</div>
                    <div class="strip-preview-route" id="stripPreviewRoute">EGNM → EGOW</div>
                    <div class="strip-preview-status">Planned</div>
                    <div class="strip-preview-details">
                      <div class="strip-detail"><span class="strip-detail-label">POB</span><span class="strip-detail-value" id="stripPreviewPob">2</span></div>
                      <div class="strip-detail"><span class="strip-detail-label">Stay</span><span class="strip-detail-value" id="stripPreviewStay">3h</span></div>
                      <div class="strip-detail"><span class="strip-detail-label">Landings</span><span class="strip-detail-value" id="stripPreviewLandings">4</span></div>
                      <div class="strip-detail"><span class="strip-detail-label">Reqs</span><span class="strip-detail-value" id="stripPreviewReqs">Parking</span></div>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="booking-actions">
                  <button type="button" class="btn btn-secondary" id="btnResetBooking">Reset</button>
                  <button type="button" class="btn btn-primary" id="btnCreateBooking" disabled>Create booking &amp; add strip →</button>
                </div>

                <div class="booking-info-note">
                  'Add strip' in this prototype stores the booking in localStorage. Wiring into your <strong>actual Live Board data</strong> model is the next step.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- HISTORY -->
        <section id="tab-history" class="tab-panel hidden">
          <div class="page-title">History</div>
          <div class="page-subtitle">Completed and cancelled movements (session).</div>

          <div class="panel">
            <div class="history-actions">
              <label class="control-label">Time Period:</label>
              <select id="historyTimePeriod" class="control-select">
                <option value="today">Today</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="48h">Last 48 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="all">All Time</option>
              </select>
              <button class="btn btn-secondary" id="btnExportHistoryCsv" type="button">
                Export History as CSV
              </button>
            </div>

            <div class="table-container">
              <table id="historyTable">
                <thead>
                  <tr>
                    <th style="width: 14px"></th>
                    <th data-sort="callsign">Callsign</th>
                    <th data-sort="regtype">Reg / Type / WTC</th>
                    <th data-sort="route">Route</th>
                    <th data-sort="time">Times</th>
                    <th data-sort="activity">Activity</th>
                    <th data-sort="status">Status</th>
                    <th style="width: 80px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="historyBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORTS -->
        <section id="tab-reports" class="tab-panel hidden">
          <div class="page-title">Reports</div>
          <div class="page-subtitle">Official monthly returns, dashboard analytics, and insights.</div>

          <!-- Reports Toolbar -->
          <div class="reports-toolbar">
            <div class="reports-controls">
              <label class="control-label">Month:</label>
              <select id="reportsMonthSelector" class="field field-select">
                <!-- Populated by JS -->
              </select>

              <label class="control-label">View:</label>
              <select id="reportsViewSelector" class="field field-select">
                <option value="official">Official Monthly Return</option>
                <option value="dashboard">Dashboard KPIs</option>
                <option value="insights">Insights & Leaderboards</option>
              </select>
            </div>

            <div class="reports-export-buttons">
              <button id="btnExportCSV" class="btn btn-secondary" title="Export movements as CSV">Export CSV</button>
              <button id="btnExportXLSX" class="btn btn-primary" title="Export monthly return as Excel">Export XLSX</button>
            </div>
          </div>

          <!-- Hours Input Panel (shown in Official view) -->
          <div id="hoursInputPanel" class="panel" style="display: none;">
            <div class="panel-header">
              <h3 class="panel-title">Daily Hours Log</h3>
            </div>
            <div class="hours-input-controls">
              <label class="control-label">Date:</label>
              <input type="date" id="hoursInputDate" class="field field-input" />

              <label class="control-label">Hours:</label>
              <input type="number" id="hoursInputValue" class="field field-input" step="0.1" min="0" max="24" placeholder="0.0" style="width: 100px;" />

              <button id="btnSaveHours" class="btn btn-secondary">Save</button>
              <button id="btnClearHours" class="btn btn-ghost">Clear</button>
            </div>
          </div>

          <!-- Reports Content Container -->
          <div class="panel">
            <div id="reportsContent">
              <!-- Content populated by JS based on selected view -->
            </div>
          </div>
        </section>

        <!-- VKB -->
        <section id="tab-vkb" class="tab-panel hidden">
          <div class="page-title">VKB Lookup</div>
          <div class="page-subtitle">Search across aircraft types, callsigns, locations, and registrations.</div>

          <div class="panel">
            <div class="lookup-toolbar">
              <input class="field field-search-global" id="vkbSearch" type="search" placeholder="Search across all VKB data…" />
              <div class="lookup-hint">Loaded from CSV databases (~6,000+ records)</div>
            </div>

            <!-- Category Tabs -->
            <div class="vkb-category-tabs">
              <button class="vkb-tab active" data-category="all">All Results</button>
              <button class="vkb-tab" data-category="types">Aircraft Types</button>
              <button class="vkb-tab" data-category="callsigns">Callsigns</button>
              <button class="vkb-tab" data-category="locations">Locations</button>
              <button class="vkb-tab" data-category="registrations">Registrations</button>
            </div>

            <!-- All Results -->
            <div class="vkb-category-content" id="vkb-all">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Details</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyAll"></tbody>
                </table>
              </div>
            </div>

            <!-- Aircraft Types -->
            <div class="vkb-category-content hidden" id="vkb-types">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>ICAO</th>
                      <th>Manufacturer</th>
                      <th>Model</th>
                      <th>WTC</th>
                      <th>Common Name</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyTypes"></tbody>
                </table>
              </div>
            </div>

            <!-- Callsigns -->
            <div class="vkb-category-content hidden" id="vkb-callsigns">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Callsign</th>
                      <th>Tricode</th>
                      <th>Common Name</th>
                      <th>Country</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyCallsigns"></tbody>
                </table>
              </div>
            </div>

            <!-- Locations -->
            <div class="vkb-category-content hidden" id="vkb-locations">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>ICAO</th>
                      <th>IATA</th>
                      <th>Airport</th>
                      <th>Location Served</th>
                      <th>Country</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyLocations"></tbody>
                </table>
              </div>
            </div>

            <!-- Registrations -->
            <div class="vkb-category-content hidden" id="vkb-registrations">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Registration</th>
                      <th>Operator</th>
                      <th>Type</th>
                      <th>Flight Type</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyRegistrations"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="tab-admin" class="tab-panel hidden">
          <div class="page-title">Admin</div>
          <div class="page-subtitle">
            LocalStorage persistence is enabled. Reset restores demo seed (and overwrites local session data).
          </div>

          <!-- Init Status -->
          <div class="panel">
            <h3>System Status</h3>
            <div id="initStatus" style="padding: 8px; background: #e8f5e9; border-left: 4px solid #4caf50; margin-bottom: 12px;">
              <strong>⏳ Initialising...</strong>
            </div>
          </div>

          <!-- Diagnostics Panel -->
          <div class="panel">
            <h3>Diagnostics</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 6px; font-weight: bold; width: 200px;">Last Init Time:</td>
                <td id="diagInitTime" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Last Render Time:</td>
                <td id="diagRenderTime" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Storage Key:</td>
                <td id="diagStorageKey" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Movement Count:</td>
                <td id="diagMovementCount" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Last Error:</td>
                <td id="diagLastError" style="padding: 6px; font-family: monospace; color: #d32f2f;">None</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Storage Usage:</td>
                <td id="diagStorageUsage" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
            </table>
          </div>

          <!-- Session Management -->
          <div class="panel">
            <h3>Session Management</h3>
            <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
              Backup your movement data to a JSON file or restore from a previous backup.
            </p>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-primary" id="btnExportSession" type="button" aria-label="Backup session data to JSON file">Backup to JSON</button>
              <button class="btn btn-primary" id="btnImportSession" type="button" aria-label="Restore session data from JSON file">Restore from JSON</button>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" aria-label="Select JSON file to import" />
          </div>

          <!-- History Settings -->
          <div class="panel">
            <h3>History Settings</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
              Control which alerts are displayed in the History tab's expanded strip details. Time-based alerts are hidden by default as they are less relevant for historical movements.
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHistoryShowTimeAlerts" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: bold;">Show time-based alerts</span>
                </label>
                <div style="font-size: 11px; color: #666; margin-left: 24px; margin-top: 4px;">
                  Includes: "Movement is X hours old", Overdue (preliminary &amp; full) action alerts
                </div>
              </div>

              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHistoryShowEmergencyAlerts" style="cursor: pointer;" checked>
                  <span style="font-size: 12px; font-weight: bold;">Show emergency alerts</span>
                </label>
                <div style="font-size: 11px; color: #666; margin-left: 24px; margin-top: 4px;">
                  Includes: Squawk 7500 (hijack), 7600 (radio failure), 7700 (general emergency)
                </div>
              </div>

              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHistoryShowCallsignAlerts" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: bold;">Show callsign confusion alerts</span>
                </label>
                <div style="font-size: 11px; color: #666; margin-left: 24px; margin-top: 4px;">
                  Includes: Registration confusion, VKB contraction, similar callsign, military callsign conflicts
                </div>
              </div>

              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHistoryShowWtcAlerts" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: bold;">Show wake turbulence category alerts</span>
                </label>
                <div style="font-size: 11px; color: #666; margin-left: 24px; margin-top: 4px;">
                  Highlights aircraft meeting or exceeding the configured WTC threshold
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline Settings -->
          <div class="panel">
            <h3>Day View / Timeline Settings</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
              Configure the timeline display above the Strip Bay on the Live Board.
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configTimelineEnabled" style="cursor: pointer;" checked>
                  <span style="font-size: 12px; font-weight: bold;">Show timeline on Live Board</span>
                </label>
                <div style="font-size: 11px; color: #666; margin-left: 24px; margin-top: 4px;">
                  Display a visual timeline showing planned and active movements throughout the day
                </div>
              </div>

              <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <div>
                  <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px;">Start Hour (UTC)</label>
                  <select id="configTimelineStartHour" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px;">
                    <option value="0">00:00</option>
                    <option value="4">04:00</option>
                    <option value="5">05:00</option>
                    <option value="6" selected>06:00</option>
                    <option value="7">07:00</option>
                    <option value="8">08:00</option>
                  </select>
                </div>
                <div>
                  <label style="font-size: 12px; font-weight: bold; display: block; margin-bottom: 4px;">End Hour (UTC)</label>
                  <select id="configTimelineEndHour" style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 3px;">
                    <option value="18">18:00</option>
                    <option value="20">20:00</option>
                    <option value="22" selected>22:00</option>
                    <option value="23">23:00</option>
                    <option value="24">24:00 (midnight)</option>
                  </select>
                </div>
              </div>
              <div style="font-size: 11px; color: #666;">
                Timeline will display movements scheduled within this UTC time window.
              </div>
            </div>
          </div>

          <!-- Configuration -->
          <div class="panel">
            <h3>Configuration</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
              Default time offsets for new movements (minutes from current time):
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
              <thead>
                <tr style="border-bottom: 1px solid #ddd;">
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Flight Type</th>
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Offset (minutes)</th>
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">DEP</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configDepOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETD defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">ARR</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configArrOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETA defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">LOC</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configLocOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETD defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">LOC Duration</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configLocDuration"
                      min="5"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETA defaults to ETD + this (default flight duration)</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">OVR Offset</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configOvrOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">EOFT defaults to now + this (Expected On Frequency Time)</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">OVR Duration</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configOvrDuration"
                      min="1"
                      max="60"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ELFT = EOFT + this (time on frequency, default 5 min)</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">OVR Activate</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configOvrAutoActivate"
                      min="5"
                      max="120"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">Auto-activate this many minutes before EOFT</td>
                </tr>
              </tbody>
            </table>

            <!-- Reciprocal Strip Settings -->
            <div style="margin-top: 16px; margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 4px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Reciprocal Strip Time Offsets
              </label>
              <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                Default time calculation when creating reciprocal strips (DEP→ARR or ARR→DEP):
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 12px; display: block; margin-bottom: 4px;">DEP → ARR (minutes)</label>
                  <input
                    type="number"
                    id="configDepToArrOffset"
                    min="0"
                    max="720"
                    placeholder="180"
                    style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                  />
                  <div style="font-size: 10px; color: #888;">ETA = ETD/ATD + this (default 3 hours)</div>
                </div>
                <div>
                  <label style="font-size: 12px; display: block; margin-bottom: 4px;">ARR → DEP (minutes)</label>
                  <input
                    type="number"
                    id="configArrToDepOffset"
                    min="0"
                    max="720"
                    placeholder="30"
                    style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                  />
                  <div style="font-size: 10px; color: #888;">ETD = ETA/ATA + this (default 30 min)</div>
                </div>
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 4px;">
                Timezone Offset (Local time relative to UTC)
              </label>
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
                <select id="configTimezoneOffset" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <option value="-12">UTC-12</option>
                  <option value="-11">UTC-11</option>
                  <option value="-10">UTC-10</option>
                  <option value="-9">UTC-9</option>
                  <option value="-8">UTC-8</option>
                  <option value="-7">UTC-7</option>
                  <option value="-6">UTC-6</option>
                  <option value="-5">UTC-5</option>
                  <option value="-4">UTC-4</option>
                  <option value="-3">UTC-3</option>
                  <option value="-2">UTC-2</option>
                  <option value="-1">UTC-1</option>
                  <option value="0" selected>UTC (GMT)</option>
                  <option value="1">UTC+1 (BST)</option>
                  <option value="2">UTC+2</option>
                  <option value="3">UTC+3</option>
                  <option value="4">UTC+4</option>
                  <option value="5">UTC+5</option>
                  <option value="6">UTC+6</option>
                  <option value="7">UTC+7</option>
                  <option value="8">UTC+8</option>
                  <option value="9">UTC+9</option>
                  <option value="10">UTC+10</option>
                  <option value="11">UTC+11</option>
                  <option value="12">UTC+12</option>
                </select>
              </div>
              <div style="font-size: 11px; color: #666;">
                Times are stored as UTC. This setting affects local time conversions shown in modals.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Banner Local Time Display
              </label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHideLocalIfSame" style="cursor: pointer;">
                  <span style="font-size: 12px;">Hide local time in banner if same as UTC</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configAlwaysHideLocal" style="cursor: pointer;">
                  <span style="font-size: 12px;">Always hide local time in banner</span>
                </label>
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 6px;">
                Control visibility of local time in the top-right banner clock display.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Alert Display Options
              </label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configEnableAlertTooltips" style="cursor: pointer;">
                  <span style="font-size: 12px;">Enable alert tooltips on hover</span>
                </label>
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 6px;">
                Show alert details when hovering over highlighted movement strips. All alerts are always visible in the expanded Details view.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Auto-Activation
              </label>
              <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
                PLANNED movements will automatically transition to ACTIVE status when within the configured time window. Movements created with past times are always activated immediately.
              </div>

              <!-- DEP Row -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; min-width: 120px;">
                  <input type="checkbox" id="configAutoActivateDepEnabled" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: 500;">Departures</span>
                </label>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="configAutoActivateDepMinutes" min="5" max="120" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;">
                  <span style="font-size: 11px; color: #666;">min before ETD</span>
                </div>
              </div>

              <!-- ARR Row -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; min-width: 120px;">
                  <input type="checkbox" id="configAutoActivateArrEnabled" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: 500;">Arrivals</span>
                </label>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="configAutoActivateArrMinutes" min="5" max="120" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;">
                  <span style="font-size: 11px; color: #666;">min before ETA</span>
                </div>
              </div>

              <!-- LOC Row -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; min-width: 120px;">
                  <input type="checkbox" id="configAutoActivateLocEnabled" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: 500;">Local Flights</span>
                </label>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="configAutoActivateLocMinutes" min="5" max="120" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;">
                  <span style="font-size: 11px; color: #666;">min before ETD</span>
                </div>
              </div>

              <!-- OVR Row -->
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; min-width: 120px;">
                  <input type="checkbox" id="configAutoActivateOvrEnabled" style="cursor: pointer;">
                  <span style="font-size: 12px; font-weight: 500;">Overflights</span>
                </label>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="configAutoActivateOvrMinutes" min="5" max="120" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;">
                  <span style="font-size: 11px; color: #666;">min before EOFT</span>
                </div>
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Wake Turbulence Category Alert
              </label>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <label style="font-size: 12px;">WTC System:</label>
                <select id="configWtcSystem" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <option value="ICAO">ICAO (L/M/H)</option>
                  <option value="UK">UK CAP 493 (L/S/LM/UM/H/J)</option>
                  <option value="RECAT">RECAT-EU (F/E/D/C/B/A)</option>
                </select>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <label style="font-size: 12px;">Alert if WTC is:</label>
                <select id="configWtcThreshold" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <!-- Options dynamically populated based on WTC system -->
                </select>
              </div>
              <div style="font-size: 11px; color: #666;">
                Highlights WTC field in yellow and shows warning in Alerts section for aircraft meeting or exceeding the selected category.
              </div>
            </div>

            <button class="btn btn-primary" id="btnSaveConfig" type="button">Save Configuration</button>
          </div>
        </section>
      </main>
    </div>

<div id="modalRoot"></div>

    <script type="module" src="./js/app.js"></script>
  </body>
</html>
