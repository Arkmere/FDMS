<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vectair FDMS Lite</title>
    <link rel="stylesheet" href="./css/vectair.css" />
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  </head>
  <body>
    <div class="app-shell">
      <header class="header">
        <div class="header-left">
          <div class="va-logo-box">VA</div>
          <div>
            <div class="va-title-main">Vectair FDMS Lite</div>
            <div class="va-title-sub">EGOW / RAF Woodvale — Demo</div>
          </div>
        </div>
        <div class="header-right">
          <div id="clockDisplay" class="clock-display">
            <div class="clock-line"><strong>UTC</strong> <span id="utcTime">--:--:--</span></div>
            <div class="clock-line" id="localTimeLine" style="display: none;"><strong>Loc</strong> <span id="localTime">--:--:--</span></div>
            <div class="clock-line"><strong>Date</strong> <span id="dateDisplay">--/--/--</span></div>
          </div>
        </div>
      </header>

      <nav class="nav-bar">
        <div class="nav-tabs" role="tablist">
          <button class="nav-tab active" data-tab="tab-live">Live Board</button>
          <button class="nav-tab" data-tab="tab-history">History</button>
          <button class="nav-tab" data-tab="tab-reports">Reports</button>
          <button class="nav-tab" data-tab="tab-vkb">VKB Lookup</button>
          <button class="nav-tab" data-tab="tab-admin">Admin</button>
        </div>
      </nav>

      <main class="page-body">
        <!-- LIVE -->
        <section id="tab-live" class="tab-panel">
          <div class="page-title">Live Board</div>
          <div class="page-subtitle">Administrative strip-style movement list (not a controlling system).</div>

          <div class="panel">
            <div class="toolbar">
              <div class="toolbar-left">
                <select class="field field-select" id="statusFilter" aria-label="Filter by status">
                  <option value="planned_active" selected>Planned & Active</option>
                  <option value="active">Active only</option>
                  <option value="all">All</option>
                </select>

                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                  <span style="white-space: nowrap;">Planned window:</span>
                  <select class="field field-select" id="plannedWindowHours" style="width: auto;" aria-label="Filter by planned time window">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="4">4 hours</option>
                    <option value="8">8 hours</option>
                    <option value="12">12 hours</option>
                    <option value="24" selected>24 hours</option>
                    <option value="48">48 hours</option>
                    <option value="168">7 days</option>
                    <option value="999999">All future</option>
                  </select>
                </label>

                <input
                  class="field field-search-global"
                  id="globalSearch"
                  type="search"
                  placeholder="Search callsign, reg, type, route, codes…"
                  aria-label="Search movements"
                />
              </div>

              <div class="toolbar-right">
                <button class="btn btn-ft btn-ft-loc" id="btnNewLoc" type="button" aria-label="Create new local flight">New LOC</button>
                <button class="btn btn-ft btn-ft-dep" id="btnNewDep" type="button" aria-label="Create new departure">New DEP</button>
                <button class="btn btn-ft btn-ft-arr" id="btnNewArr" type="button" aria-label="Create new arrival">New ARR</button>
                <button class="btn btn-ft btn-ft-ovr" id="btnNewOvr" type="button" aria-label="Create new overflight">New OVR</button>
              </div>
            </div>

            <div class="table-container">
              <table aria-label="Live Board movements">
                <thead>
                  <tr>
                    <th scope="col" style="width: 14px"></th>
                    <th scope="col">Callsign</th>
                    <th scope="col" style="width: 36px; text-align: center" title="Flight Priority"></th>
                    <th scope="col">Reg / Type / WTC</th>
                    <th scope="col">Route</th>
                    <th scope="col" style="width: 50px; text-align: center">Rules</th>
                    <th scope="col">Times</th>
                    <th scope="col" style="width: 80px; text-align: center">T&amp;G</th>
                    <th scope="col" style="width: 80px; text-align: center">O/S</th>
                    <th scope="col" style="width: 80px; text-align: center">FIS</th>
                    <th scope="col">Remarks</th>
                    <th scope="col" style="width: 250px; text-align: right">Actions</th>
                  </tr>
                </thead>
                <tbody id="liveBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- HISTORY -->
        <section id="tab-history" class="tab-panel hidden">
          <div class="page-title">History</div>
          <div class="page-subtitle">Completed and cancelled movements (session).</div>

          <div class="panel">
            <div class="history-actions">
              <label class="control-label">Time Period:</label>
              <select id="historyTimePeriod" class="control-select">
                <option value="today">Today</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="48h">Last 48 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="all">All Time</option>
              </select>
              <button class="btn btn-secondary" id="btnExportHistoryCsv" type="button">
                Export History as CSV
              </button>
            </div>

            <div class="table-container">
              <table id="historyTable">
                <thead>
                  <tr>
                    <th style="width: 14px"></th>
                    <th data-sort="callsign">Callsign</th>
                    <th data-sort="regtype">Reg / Type / WTC</th>
                    <th data-sort="route">Route</th>
                    <th data-sort="time">Times</th>
                    <th data-sort="activity">Activity</th>
                    <th data-sort="status">Status</th>
                    <th style="width: 80px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="historyBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORTS -->
        <section id="tab-reports" class="tab-panel hidden">
          <div class="page-title">Reports</div>
          <div class="page-subtitle">Official monthly returns, dashboard analytics, and insights.</div>

          <!-- Reports Toolbar -->
          <div class="reports-toolbar">
            <div class="reports-controls">
              <label class="control-label">Month:</label>
              <select id="reportsMonthSelector" class="field field-select">
                <!-- Populated by JS -->
              </select>

              <label class="control-label">View:</label>
              <select id="reportsViewSelector" class="field field-select">
                <option value="official">Official Monthly Return</option>
                <option value="dashboard">Dashboard KPIs</option>
                <option value="insights">Insights & Leaderboards</option>
              </select>
            </div>

            <div class="reports-export-buttons">
              <button id="btnExportCSV" class="btn btn-secondary" title="Export movements as CSV">Export CSV</button>
              <button id="btnExportXLSX" class="btn btn-primary" title="Export monthly return as Excel">Export XLSX</button>
            </div>
          </div>

          <!-- Hours Input Panel (shown in Official view) -->
          <div id="hoursInputPanel" class="panel" style="display: none;">
            <div class="panel-header">
              <h3 class="panel-title">Daily Hours Log</h3>
            </div>
            <div class="hours-input-controls">
              <label class="control-label">Date:</label>
              <input type="date" id="hoursInputDate" class="field field-input" />

              <label class="control-label">Hours:</label>
              <input type="number" id="hoursInputValue" class="field field-input" step="0.1" min="0" max="24" placeholder="0.0" style="width: 100px;" />

              <button id="btnSaveHours" class="btn btn-secondary">Save</button>
              <button id="btnClearHours" class="btn btn-ghost">Clear</button>
            </div>
          </div>

          <!-- Reports Content Container -->
          <div class="panel">
            <div id="reportsContent">
              <!-- Content populated by JS based on selected view -->
            </div>
          </div>
        </section>

        <!-- VKB -->
        <section id="tab-vkb" class="tab-panel hidden">
          <div class="page-title">VKB Lookup</div>
          <div class="page-subtitle">Search across aircraft types, callsigns, locations, and registrations.</div>

          <div class="panel">
            <div class="lookup-toolbar">
              <input class="field field-search-global" id="vkbSearch" type="search" placeholder="Search across all VKB data…" />
              <div class="lookup-hint">Loaded from CSV databases (~6,000+ records)</div>
            </div>

            <!-- Category Tabs -->
            <div class="vkb-category-tabs">
              <button class="vkb-tab active" data-category="all">All Results</button>
              <button class="vkb-tab" data-category="types">Aircraft Types</button>
              <button class="vkb-tab" data-category="callsigns">Callsigns</button>
              <button class="vkb-tab" data-category="locations">Locations</button>
              <button class="vkb-tab" data-category="registrations">Registrations</button>
            </div>

            <!-- All Results -->
            <div class="vkb-category-content" id="vkb-all">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Code</th>
                      <th>Label</th>
                      <th>Details</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyAll"></tbody>
                </table>
              </div>
            </div>

            <!-- Aircraft Types -->
            <div class="vkb-category-content hidden" id="vkb-types">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>ICAO</th>
                      <th>Manufacturer</th>
                      <th>Model</th>
                      <th>WTC</th>
                      <th>Common Name</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyTypes"></tbody>
                </table>
              </div>
            </div>

            <!-- Callsigns -->
            <div class="vkb-category-content hidden" id="vkb-callsigns">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Callsign</th>
                      <th>Tricode</th>
                      <th>Common Name</th>
                      <th>Country</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyCallsigns"></tbody>
                </table>
              </div>
            </div>

            <!-- Locations -->
            <div class="vkb-category-content hidden" id="vkb-locations">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>ICAO</th>
                      <th>IATA</th>
                      <th>Airport</th>
                      <th>Location Served</th>
                      <th>Country</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyLocations"></tbody>
                </table>
              </div>
            </div>

            <!-- Registrations -->
            <div class="vkb-category-content hidden" id="vkb-registrations">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Registration</th>
                      <th>Operator</th>
                      <th>Type</th>
                      <th>Flight Type</th>
                      <th style="width: 110px; text-align: right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vkbBodyRegistrations"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="tab-admin" class="tab-panel hidden">
          <div class="page-title">Admin</div>
          <div class="page-subtitle">
            LocalStorage persistence is enabled. Reset restores demo seed (and overwrites local session data).
          </div>

          <!-- Init Status -->
          <div class="panel">
            <h3>System Status</h3>
            <div id="initStatus" style="padding: 8px; background: #e8f5e9; border-left: 4px solid #4caf50; margin-bottom: 12px;">
              <strong>⏳ Initialising...</strong>
            </div>
          </div>

          <!-- Diagnostics Panel -->
          <div class="panel">
            <h3>Diagnostics</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 6px; font-weight: bold; width: 200px;">Last Init Time:</td>
                <td id="diagInitTime" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Last Render Time:</td>
                <td id="diagRenderTime" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Storage Key:</td>
                <td id="diagStorageKey" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Movement Count:</td>
                <td id="diagMovementCount" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Last Error:</td>
                <td id="diagLastError" style="padding: 6px; font-family: monospace; color: #d32f2f;">None</td>
              </tr>
              <tr>
                <td style="padding: 6px; font-weight: bold;">Storage Usage:</td>
                <td id="diagStorageUsage" style="padding: 6px; font-family: monospace;">—</td>
              </tr>
            </table>
          </div>

          <!-- Session Management -->
          <div class="panel">
            <h3>Session Management</h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-primary" id="btnExportSession" type="button" aria-label="Export session data to JSON file">Export Session JSON</button>
              <button class="btn btn-primary" id="btnImportSession" type="button" aria-label="Import session data from JSON file">Import Session JSON</button>
              <button class="btn btn-secondary" id="btnResetDemo" type="button" aria-label="Reset session to demo data">Reset to Demo Data</button>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" aria-label="Select JSON file to import" />
          </div>

          <!-- Configuration -->
          <div class="panel">
            <h3>Configuration</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
              Default time offsets for new movements (minutes from current time):
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 12px;">
              <thead>
                <tr style="border-bottom: 1px solid #ddd;">
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Flight Type</th>
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Offset (minutes)</th>
                  <th style="text-align: left; padding: 6px; font-weight: bold;">Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">DEP</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configDepOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETD defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">ARR</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configArrOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETA defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">LOC</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configLocOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETD defaults to now + this</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">LOC Duration</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configLocDuration"
                      min="5"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ETA defaults to ETD + this (default flight duration)</td>
                </tr>
                <tr>
                  <td style="padding: 6px; font-weight: bold;">OVR</td>
                  <td style="padding: 6px;">
                    <input
                      type="number"
                      id="configOvrOffset"
                      min="0"
                      max="180"
                      style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                    />
                  </td>
                  <td style="padding: 6px; font-size: 11px; color: #666;">ECT defaults to now + this</td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 4px;">
                Timezone Offset (Local time relative to UTC)
              </label>
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
                <select id="configTimezoneOffset" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <option value="-12">UTC-12</option>
                  <option value="-11">UTC-11</option>
                  <option value="-10">UTC-10</option>
                  <option value="-9">UTC-9</option>
                  <option value="-8">UTC-8</option>
                  <option value="-7">UTC-7</option>
                  <option value="-6">UTC-6</option>
                  <option value="-5">UTC-5</option>
                  <option value="-4">UTC-4</option>
                  <option value="-3">UTC-3</option>
                  <option value="-2">UTC-2</option>
                  <option value="-1">UTC-1</option>
                  <option value="0" selected>UTC (GMT)</option>
                  <option value="1">UTC+1 (BST)</option>
                  <option value="2">UTC+2</option>
                  <option value="3">UTC+3</option>
                  <option value="4">UTC+4</option>
                  <option value="5">UTC+5</option>
                  <option value="6">UTC+6</option>
                  <option value="7">UTC+7</option>
                  <option value="8">UTC+8</option>
                  <option value="9">UTC+9</option>
                  <option value="10">UTC+10</option>
                  <option value="11">UTC+11</option>
                  <option value="12">UTC+12</option>
                </select>
              </div>
              <div style="font-size: 11px; color: #666;">
                Times are stored as UTC. This setting affects local time conversions shown in modals.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Banner Local Time Display
              </label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configHideLocalIfSame" style="cursor: pointer;">
                  <span style="font-size: 12px;">Hide local time in banner if same as UTC</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configAlwaysHideLocal" style="cursor: pointer;">
                  <span style="font-size: 12px;">Always hide local time in banner</span>
                </label>
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 6px;">
                Control visibility of local time in the top-right banner clock display.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Alert Display Options
              </label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configEnableAlertTooltips" style="cursor: pointer;">
                  <span style="font-size: 12px;">Enable alert tooltips on hover</span>
                </label>
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 6px;">
                Show alert details when hovering over highlighted movement strips. All alerts are always visible in the expanded Details view.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Auto-Activate Arrivals
              </label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="configAutoActivateEnabled" style="cursor: pointer;">
                  <span style="font-size: 12px;">Automatically activate PLANNED arrivals before ETA</span>
                </label>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                <label style="font-size: 12px;">Minutes before ETA:</label>
                <input
                  type="number"
                  id="configAutoActivateMinutes"
                  min="5"
                  max="120"
                  style="width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 3px;"
                />
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 6px;">
                When enabled, PLANNED arrival movements will automatically transition to ACTIVE status this many minutes before their ETA.
              </div>
            </div>

            <div style="margin-top: 16px; margin-bottom: 12px;">
              <label style="display: block; font-weight: bold; margin-bottom: 8px;">
                Wake Turbulence Category Alert
              </label>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <label style="font-size: 12px;">WTC System:</label>
                <select id="configWtcSystem" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <option value="ICAO">ICAO (L/M/H)</option>
                  <option value="UK">UK CAP 493 (L/S/LM/UM/H/J)</option>
                  <option value="RECAT">RECAT-EU (F/E/D/C/B/A)</option>
                </select>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <label style="font-size: 12px;">Alert if WTC is:</label>
                <select id="configWtcThreshold" style="padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                  <!-- Options dynamically populated based on WTC system -->
                </select>
              </div>
              <div style="font-size: 11px; color: #666;">
                Highlights WTC field in yellow and shows warning in Alerts section for aircraft meeting or exceeding the selected category.
              </div>
            </div>

            <button class="btn btn-primary" id="btnSaveConfig" type="button">Save Configuration</button>
          </div>
        </section>
      </main>
    </div>

<div id="modalRoot"></div>

    <script type="module" src="./js/app.js"></script>
  </body>
</html>
